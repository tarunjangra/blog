<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>ElasticSearch restore failed when s3-gateway is activated</title>
    <link rel="canonical" href="http://tarunjangra.com/2014/07/11/elasticSearch-restore-failed-when-s3-gateway-activated.html">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico?b676031">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "http://tarunjangra.com/2014/07/11/elasticSearch-restore-failed-when-s3-gateway-activated.html"
        },
        "headline": "ElasticSearch restore failed when s3-gateway is activated",
        "image": {
          "@type": "ImageObject",
          "url": "http://tarunjangra.com/images/about/tarun-jangar-600x600.jpg",
          "height": 600,
          "width": 600
        },
        "datePublished": "2014-07-11",
        "dateModified": "2014-07-11",
        "author": {
          "@type": "Person",
          "name": "Tarun Jangra"
        },
        "publisher": {
          "@type": "Organization",
          "name": "tarunjangra.com",
          "logo": {
            "@type": "ImageObject",
            "url": "http://tarunjangra.com/about/tarun-jangra-500x500.jpg",
            "width": 500,
            "height": 500
          }
        },
        "description": "ElasticSearch restore failed when s3-gateway is activated. And it made me in the
kind of situation which are really tough to recorver from.
",
        "keywords": ["blogging", "tarun jangra", "elastic search", "elastica", "S3-gateway"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <style amp-custom="amp-custom">
      body { padding: 2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <h1>ElasticSearch restore failed when s3-gateway is activated</h1>
      <p>Hufffff, Unfortunately i met this edge case. I have recovered from this situation. Here’s my scenario.</p>

<ul>
<li>I am on ElasticSearch Version 1.1.0</li>
<li>I have two data nodes. One is primary and other is replica.</li>
<li>I am taking regular snapshots of my indexes.</li>
<li>I am no more taking snapshots, So I have installed s3-gateway plugin to keep updating s3 buckets for persistent indexes.</li>
</ul>



<p>Because of bulk import, i have stopped my replica to make import little faster. Once import get completed. I felt high CPU and Memory usage. And since i was aware that my indexes are safe because i am supporting s3-gateway. So i decided to restart remaining data node. Fuck…. It was a big mistake. When i tried to restart, it was not recovering all indexes. And we were about to launch our site in next two hours. And i am left with no index.</p>

<p>Struggling here and there, i came to know that i am suffered with Bug in ElasticSearch. I tried to follow instruction at the end of this thread where i was suppose to update/edit metadata file from s3-bucket. I did that but no luck.</p>

<p>Problem i found, All indexes and shards suppose to have _source folders. And i had so many indexes and their shards where _source folder was missing. And those indexes were unrecoverable. I have no solutions at that place and was literately sweating in Air Conditioned Room. </p>

<p>Then one of my colleague, Narinder Kaur has joined me. And she gave me necessary support and we tried some more messes to fix it. Since i already made a mistake, So i took one backup of existing elasticsearch so that i would be able to back at same place in case of any other mess. And solutions we were planning to try was totally crap.</p>

<p>So, Solution we tried. and which actually works….. Wow!.</p>

<ol>
<li>I updated my elasticsearch.yml, and remove s3-gateway settings related to my s3 bucket.</li>
<li>I stopped elasticsearch.</li>
<li>I rename my old cluster (elasticsearch) to elasticsearch.original.</li>
<li>Restarted Elasticsearch. And it created new blank cluster. where i have no indexes.</li>
<li>I created all required indexes with the same number of shards and replicas i previously had. In my case i had 5 indexes and 5 shards per index.</li>
<li>Now i stop elasticsearch again.</li>
<li>Start deleting (elasticsearch/nodes/0/indices/{index_name}&gt;/{0,1,2,3,4}/{index,translog}. And move (elasticsearch.original/nodes/0/indices/{index_name}/{0,1,2,3,4}/{index,translog}) to (elasticsearch/nodes/0/indices/{index_name}/&lt;0,1,2,3,4&gt;/{index,translog})
<strong>Note</strong>: Here, i did not touch _state folder of blank indexes. And now my all indexes has _status folder in each shard and each index.</li>
<li>I copied all indexes as in 5th step.</li>
<li>Restart ElasticSearch. and i found all indexes were recovered.</li>
</ol>

<p>Observation: Well you should run your all custom mappings in blank indexes. I found some errors because i did not execute my mapping.</p>

<p>Thank god, Now all indexes were recovered. And Thanks to Narinder Kaur, she got me required support at that time.</p>

    </article>
  </body>
</html>
